# System configuration
system:
  name: "QuantiCity Capital"
  version: "1.0.0"
  environment: "development"

# Market configuration
market:
  check_staleness_after_hours: false
  extended_hours: true

# Redis configuration
redis:
  host: "127.0.0.1"
  port: 6379
  db: 0
  password: null
  decode_responses: true
  max_connections: 100  # Increased for high throughput
  socket_keepalive: true

# IBKR configuration
ibkr:
  host: "127.0.0.1"
  port: 7497  # 7497 for paper, 7496 for live
  client_id: 1
  timeout: 10
  readonly: false
  
  # Exchange-specific L2 configuration
  level2_exchanges:
    SPY: ["ARCA", "BATS", "IEX"]
    QQQ: ["ISLAND", "ARCA", "BATS"]
    IWM: ["ARCA", "BATS"]
  
  smart_depth: false  # Never use SMART aggregation
  l2_num_rows: 10
  max_reconnect_attempts: 10
  reconnect_delay_base: 2

# Alpha Vantage configuration
alpha_vantage:
  api_key: "${ALPHA_VANTAGE_API_KEY}"
  base_url: "https://www.alphavantage.co/query"
  calls_per_minute: 600
  safety_buffer: 10
  retry_attempts: 3
  retry_delay: 2
  failure_threshold: 3
  failure_backoff_seconds: 120
  failure_backoff_max: 900
  options_pubsub_channel: "events:options:chain"
  sentiment:
    skip_symbols: ["SPY", "QQQ", "IWM", "VXX"]
  options_update_interval: 10
  sentiment_update_interval: 300
  technicals_update_interval: 60

# Symbols configuration
symbols:
  level2: ["SPY", "QQQ", "IWM"]
  standard: ["AAPL", "TSLA", "NVDA", "AMD", "GOOGL", "META", "AMZN", "MSFT", "PLTR", "VXX"]

# Modules configuration
modules:
  data_ingestion:
    enabled: true
    data_freshness_threshold: 5
    
    # Single TTL source (balanced for analytics requirements)
    store_ttls:
      market_data: 60      # Keep quotes for 1 minute
      order_book: 60       # Keep order books for 1 minute  
      bars: 3600           # Keep bars for 1 hour (need 100+ for analytics)
      trades: 3600         # Keep trades for 1 hour (need 1000+ for VPIN)
      options_chain: 300    # Keep options for 1 minute
      greeks: 300           # Keep greeks for 1 minute
      sentiment: 300       # Keep sentiment for 5 minutes
      technicals: 300      # Keep technicals for 5 minutes
      metrics: 60          # Keep metrics for 1 minute
      monitoring: 60       # Keep monitoring for 1 minute
      heartbeat: 15        # Keep heartbeat for 15 seconds
  
  analytics:
    enabled: true
    cadence_hz: 2
    analytics_rth_only: false
    store_ttls:
      analytics: 60
      portfolio: 60
      sector: 120
      correlation: 900
      heartbeat: 15
    update_intervals:
      vpin: 5
      gex_dex: 30
      flow_toxicity: 60
      order_book: 1
      sweep_detection: 2
      portfolio: 15
      sectors: 30
      correlation: 300
      dealer_flows: 60
      flow_clustering: 90
      volatility: 60
      moc: 30
      unusual_activity: 60
    sector_map:
      SPY: INDEX
      QQQ: TECH
      IWM: SMALLCAP
      AAPL: TECH
      TSLA: AUTO
      NVDA: TECH
      AMD: SEMI
      GOOGL: TECH
      META: TECH
      AMZN: CONSUMER
      MSFT: TECH
      VXX: VOLATILITY
    dealer_flow:
      history_window: 240
      max_expiry_days: 30
      contract_multiplier: 100
      min_open_interest: 5
      vol_beta: -0.30
      sigma_floor: 0.02
      min_samples: 20
    volatility:
      history_window: 480
      timeout: 10
      ttl: 300
      data_sources:
        primary: cboe
        enable_fallback: true
        cache_duration: 300
      vix1d_thresholds:
        shock: 35
        elevated: 25
        benign: 18
      change_thresholds:
        shock: 5.0
        elevated: 2.0
    flow_clustering:
      window_trades: 200
      min_trades: 40
      institutional_size: 250
      random_state: 42
      ttl: 180
  
  signals:
    enabled: true
    dry_run: false
    publish_channel: "signals:out"

    # Guardrails (apply before any strategy logic)
    max_staleness_s: 60        # upstream inputs must be this fresh
    min_confidence: 0.90      # global floor; per-strategy may override
    min_refresh_s: 5          # min spacing between recalcs per symbol (increased from 2 to reduce churn)
    cooldown_s: 30            # block re-emitting same contract within window (now contract-scoped)
    ttl_seconds: 300          # TTL for emitted keys
    version: "D6.0.1"

    # Optional global blend (for future hybrid scorers)
    weights:
      vpin: 0.15
      toxicity: 0.10
      gex: 0.15
      dex: 0.05
      trend: 0.15
      vol: 0.05
      vanna: 0.10
      charm: 0.05
      hedging: 0.10
      skew: 0.05
      flow_momentum: 0.05
      vix1d: 0.10

    strategies:
      0dte:
        enabled: true
        symbols: ["SPY","QQQ","IWM"]
        time_window: { start: "09:45", end: "16:00" }  # Market hours only
        confidence_weights:
          vpin: 30
          obi: 25
          gamma_proximity: 30
          sweep: 15
          dealer_flow: 20
          skew: 10
          flow_clusters: 15
        thresholds:
          min_confidence: 90
          vpin_min: 0.40
          obi_min: 0.30
          gamma_pin_distance: 0.005   # 0.5%
          vanna_notional_min: 150000000
          charm_notional_min: 60000000
          skew_sigma: 1.0
          flow_momentum_min: 0.35
          hedging_notional_max: 500000000

      1dte:
        enabled: true
        symbols: ["SPY","QQQ","IWM","VXX"]
        time_window: { start: "14:00", end: "16:00" }  # Afternoon session
        confidence_weights:
          volatility_regime: 20
          obi: 30
          gex: 25
          vpin: 25
          vix1d: 20
        thresholds:
          min_confidence: 90
          hedging_notional_max: 400000000
          vanna_notional_min: 100000000

      14dte:
        enabled: true
        symbols: ["AAPL","TSLA","NVDA","AMD","GOOGL","META","AMZN","MSFT","PLTR"]
        time_window: { start: "09:30", end: "16:00" }  # Full market hours
        confidence_weights:
          unusual_options: 40
          sweep: 30
          hidden_orders: 20
          dex: 10
        thresholds:
          min_confidence: 90

      moc:
        enabled: true
        symbols: ["SPY","QQQ"]
        time_window: { start: "15:30", end: "16:00" }  # MOC window
        # Confidence components (sum to 100 possible)
        confidence_weights:
          imbalance_strength: 45     # size & ratio
          gamma_pull: 25             # towards nearest pin
          obi: 20                    # intraday book skew
          friday_factor: 10          # optional uplift (weekly flows)
        thresholds:
          min_confidence: 90
          min_imbalance_notional: 2.0e9      # $2B combined or symbol-appropriate
          min_imbalance_ratio: 0.60          # |Imbalance| / (Paired + |Imbalance|)
          max_spread_bps: 8                  # option NBBO spread ≤ 8 bps of spot
          min_option_oi: 2000                # open interest floor per leg
          max_contract_gamma_risk: 0.020     # approximate ΔGamma vs 0.5% move
        options:
          expiry: "0DTE"                     # same-day
          side: "trend"                      # with the imbalance direction
          target_delta: 0.25                 # ~25d
          alt_delta_if_pin: 0.15             # farther OTM if pin risk is high
          max_mid_slippage_bps: 4            # quoted vs mid control
          exit: "close"                      # conceptual; Day-6 = signals only

    distribution:
      tiers:
        premium: { delay_seconds: 0,   include_all_details: true }
        basic:   { delay_seconds: 60,  include_all_details: false }
        free:    { delay_seconds: 300, include_all_details: false }

  execution:
    enabled: false  # Day 6+

  dashboard:
    enabled: false  # Day 7+

  social_media:
    enabled: false  # Day 7+

  analysis_publisher:
    enabled: true
    moc:
      symbols: ["SPY", "QQQ", "IWM"]
      schedule: ["08:00", "10:00", "12:00", "14:00", "15:45"]
      window_start: "08:00"
      min_notional: 500000000       # $500M minimum to feature
      min_watchlist_ratio: 0.40
      stale_after_seconds: 180
      historical_ttl_hours: 72
      ping_thresholds:
        extreme_notional: 5000000000
        final_notional: 2000000000
      market_holidays: []           # Optional list of YYYY-MM-DD strings

discord:
  enabled: true
  queue_processing:
    block_timeout: 2            # Seconds for Redis BRPOP timeout
    idle_sleep_seconds: 0.2     # Sleep duration when queues are empty
    dedupe_ttl_seconds: 900     # Prevent duplicate posts for 15 minutes
    max_retry_attempts: 5
    retry_backoff_seconds: [1, 3, 7, 15, 30]
  tiers:
    premium:
      queue: "distribution:premium:queue"
      webhook_key: "premium-signals"
      detail_level: "premium"
      mention: "@everyone"
    basic:
      queue: "distribution:basic:queue"
      webhook_key: "basic-signals-60s"
      detail_level: "basic"
      mention: "@everyone"
    free:
      queue: "distribution:free:queue"
      webhook_key: "free-signals-5min"
      detail_level: "teaser"
      mention: "@everyone"
    premium_analysis:
      queue: "analysis:premium:moc"
      webhook_key: "premium-analysis"
      detail_level: "analysis"
      mention: null
  formatting:
    colors:
      long: 3066993      # 0x2ecc71
      short: 15158332    # 0xe74c3c
      neutral: 40447     # 0x009ddf
    analysis:
      neutral: 40447
      extreme: 15158332
    premium_rationale_tags:
      flow: "Flow imbalance + dealer hedge unwind alignment"
      volatility: "Volatility regime supportive"
      structure: "Market structure confirms bias"
      sentiment: "Sentiment composite supportive"
    basic_rationale_tags:
      flow: "Flow alignment"
      volatility: "Volatility check"
      structure: "Structure aligned"
    basic_upgrade_text: "Premium members receive instant alerts."
    free_upgrade_text: "Upgrade for full details! Unlock live entries, contract specs, and risk plan with Premium."
    teaser_cta: "Unlock live entries, contract specs, and risk plan with Premium."
  fallbacks:
    log_webhook_key: "bot-logs"

# Risk Management configuration (Day 7)
risk_management:
  enabled: true
  max_daily_loss_pct: 20.0         # 20% of account value (paper mode)
  max_position_loss_pct: 1.0        # 1% max loss per position
  consecutive_loss_limit: 3         # Halt after 3 consecutive losses
  correlation_limit: 0.7            # Max portfolio correlation
  margin_buffer: 1.25               # 25% margin buffer required
  max_drawdown_pct: 10.0           # 10% max drawdown from HWM
  
  # Trailing stop behaviour can be tuned per instrument type or strategy
  trailing_stops:
    option:
      profit_trigger: 0.1          # Begin trailing after ~10% move in option value
      trail_percent: 0.6           # Lock in 60% of gains once active
    stock:
      profit_trigger: 0.02         # Trail equity positions after ~2% move
      trail_percent: 0.5           # Keep half of the captured gains
    default:
      profit_trigger: 0.2
      trail_percent: 0.5

  # Dynamic stop engine configuration (used by execution + position manager)
  dynamic_stops: {}
  
  # Circuit breakers
  circuit_breakers:
    daily_loss: true
    consecutive_losses: true
    volatility_spike: true
    system_errors: true
    max_drawdown: true
  
  # VaR parameters
  var_confidence: 0.95              # 95% confidence level
  var_lookback_days: 30             # Days of history for VaR
  
  # Position limits
  max_positions: 10                 # Max concurrent positions (updated from 5)
  max_per_symbol: 5                 # Max positions per symbol (updated from 2)

# Legacy risk configuration (kept for backward compatibility)
risk:
  circuit_breakers:
    enabled: false
    max_daily_loss: 20000
    max_position_loss: 1000
    max_correlation: 0.7
    halt_on_disconnect: true

# Parameter discovery configuration (kept for reference)
parameter_discovery:
  enabled: true
  run_on_startup: true
  startup_delay: 60  
  interval_seconds: 900  
  schedule: "0 9 * * *"  
  ttl_seconds: 86400  
  data_staleness_threshold: 3600  
  
  vpin:
    min_bucket_size: 50
    max_bucket_size: 500
    num_clusters: 5
    min_trades_required: 1000
    default_bucket_size: 100
  
  temporal:
    max_lookback: 30
    min_bars_required: 100
    significance_threshold: 0.05
    default_lookback: 10
  
  market_makers:
    toxic_list: ["CDRG", "JANE", "VIRTU", "SUSG"]
    hft_size_threshold: 100
    institutional_size_threshold: 1000
    min_orders_required: 100
    toxicity_scores:
      toxic: 1.0
      hft: 0.7
      institutional: 0.2
      other: 0.3
  
  # New pattern-based toxicity detection
  toxicity_detection:
    method: "pattern_based"  # Switch from "market_maker_based" to this
    vpin_thresholds:
      toxic: 0.70
      informed: 0.30
    venue_scores:  # Venue-based toxicity scores (from Warning 2152)
      # Main exchanges (Depth venues)
      NASDAQ: 0.50   # NASDAQ main book (full name)
      NSDQ: 0.50     # NASDAQ main book (short code)
      NYSE: 0.35     # NYSE institutional
      ARCA: 0.40     # NYSE ARCA institutional
      BATS: 0.70     # CBOE BZX, mixed retail/HFT
      BEX: 0.65      # CBOE BEX, retail flow
      IEX: 0.20      # Speed bump protects from HFT
      
      # Secondary venues (Top venues from warning)
      BYX: 0.70      # CBOE BYX, retail-heavy
      PEARL: 0.75    # MIAX PEARL, options/retail
      AMEX: 0.45     # NYSE American, mixed flow
      MEMX: 0.65     # Members Exchange, aggressive pricing
      EDGEA: 0.75    # CBOE EDGA, retail flow
      EDGX: 0.80     # CBOE EDGX, retail-heavy PFOF
      DRCTEDGE: 0.75 # Direct Edge, retail
      PSX: 0.65      # NASDAQ PSX, retail-focused
      ISE: 0.70      # International Securities Exchange
      CHX: 0.60      # Chicago Stock Exchange
      LTSE: 0.40     # Long-Term Stock Exchange
      NYSENAT: 0.35  # NYSE National, institutional
      
      # IB internal and special venues
      IBEOS: 0.60    # IB's internal smart router
      IBKRATS: 0.60  # IB internal routing
      OVERNIGHT: 0.50 # Extended hours trading
      SMART: 0.50     # IB SMART routing (mixed flow)
      
      # Dark pools and unknown
      DARK: 0.50     # Unknown dark pool
      UNKNOWN: 0.50  # Default for unknown venues
    trade_patterns:
      odd_lot_weight: 0.70   # Odd lots indicate retail
      sweep_weight: 0.90     # Sweeps indicate aggressive/toxic
      block_weight: -0.50    # Large blocks indicate institutional
    block_threshold: 10000   # Shares for block trade
    sweep_window_ms: 250     # Time window for sweep detection
  
  volatility:
    window_bars: 20
    low_percentile: 33
    high_percentile: 67
    bars_per_day: 4680
    trading_days_per_year: 252
    min_bars_for_regime: 500
    default_regime: "NORMAL"
  
  correlation:
    min_bars: 100
    calculation_window: 500
    forward_fill_limit: 5
    min_correlation_symbols: 3

# Logging configuration
logging:
  level: "INFO"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file_path: "logs/quanticity_capital.log"
  max_bytes: 10485760  # 10MB
  backup_count: 5
  console: true
  colorize: true

# Monitoring configuration
monitoring:
  health_check_interval: 1
  heartbeat_timeout: 10
  alert_email: null
